# 项目端口管理器 - 设计文档 (v1.0)

## 一、 系统架构

### 1.1 总体架构
本系统采用 **C/S (Browser-Based)** 架构：
- **前端 (Frontend)**：HTML + CSS + JavaScript (Static File)，运行在浏览器端。
    - **职责**：
        - 向用户展示项目列表和状态。
        - 向后端发送启动/停止指令。
        - 实时刷新服务状态。
- **后端 (Backend)**：Python FastAPI，运行在本地主机 (Host)。
    - **职责**：
        - **API 层**：提供 RESTful 接口 (projects, services)。
        - **业务逻辑层 (Core)**：
            - `ProcessManager`：封装 `subprocess` 调用，管理进程生命周期。
            - `PortMonitor`：利用 `socket` 或 `netstat` 检测端口状态。
            - `ConfigManager`：读写 `config.json`。
        - **数据层**：`config.json` 文件存储。

### 1.2 数据模型 (Data Model)
核心数据结构定义如下（对应 `config.json`）：

```json
{
  "projects": [
    {
      "id": "string (unique)",
      "name": "string (display name)",
      "root_path": "string (absolute path)",
      "frontend_url": "string (optional)",
      "services": [
        {
          "id": "string (unique within project)",
          "name": "string (e.g. Backend, Frontend)",
          "type": "string (backend|frontend|other)",
          "cwd": "string (working directory)",
          "command": "string (execution command)",
          "ports": [int] (list of ports to monitor)
        }
      ]
    }
  ]
}
```

## 二、 核心模块详细设计

### 2.1 启动流程 (Startup Flow)
1.  **加载配置**：应用启动时读取 `config.json`。
2.  **Web 服务启动**：FastAPI 监听端口 `5555`。
3.  **自检**：检查端口 `5555` 是否被占用，若被占用则尝试清理（仅限启动脚本）。

### 2.2 服务启动逻辑 (Service Start Logic)
1.  **接口调用**：`POST /services/{id}/start`。
2.  **查找服务**：根据 ID 找到对应配置。
3.  **检查运行状态**：若已在 `processes` 字典中且 `poll() is None`，直接返回 "already_running"。
4.  **执行命令**：
    - 使用 `subprocess.Popen(command, shell=True, cwd=cwd)` 启动进程。
    - 保存进程对象至 `processes` 字典。
5.  **返回结果**：返回 `{ "status": "started", "pid": pid }`。

### 2.3 服务停止逻辑 (Service Stop Logic) - **关键设计**
1.  **接口调用**：`POST /services/{id}/stop`。
2.  **查找进程对象**：在 `processes` 字典中查找。
3.  **分支处理**：
    - **情况 A：进程对象存在**
        - Windows：执行 `taskkill /F /T /PID {pid}`，强制结束进程树。
        - Linux/macOS：调用 `proc.terminate()`。
    - **情况 B：进程对象不存在 (孤儿进程)**
        - **端口反查**：遍历该服务配置的所有端口。
        - **Netstat 查找**：执行 `netstat -ano | findstr :{port}` 获取占用该端口的 PID。
        - **安全校验**：排除系统进程 (PID 0, 4)。
        - **强制结束**：执行 `taskkill /F /PID {pid}`。
4.  **返回结果**：返回 `{ "status": "stopping" | "stopping_external" }`。

### 2.4 状态监控逻辑 (Status Monitor Logic)
1.  **接口调用**：`GET /services/status`。
2.  **遍历所有服务**：
    - **Manager Running**：检查 `processes` 中是否有对应的活跃进程对象。
    - **Port Occupied**：通过 `socket.connect` 尝试连接端口，成功则视为占用。
    - **Running**：`Manager Running` 或 `Port Occupied` 为真。
3.  **返回列表**：包含每个服务的详细状态。

## 三、 接口设计 (API Design)

| Method | Endpoint | Description |
| :--- | :--- | :--- |
| `GET` | `/projects` | 获取所有项目配置列表 |
| `POST` | `/projects` | 注册新项目 |
| `DELETE` | `/projects/{id}` | 注销项目 |
| `GET` | `/services/status` | 获取所有服务的实时状态 |
| `POST` | `/services/{id}/start` | 启动指定服务 |
| `POST` | `/services/{id}/stop` | 停止指定服务 |
| `POST` | `/projects/{id}/start` | 启动项目下的所有服务 |
| `POST` | `/projects/{id}/stop` | 停止项目下的所有服务 |

## 四、 界面设计 (UI Design)
- **Dashboard**：
    - 顶部导航栏：Logo + 项目列表入口。
    - 主体区域：以卡片形式展示每个项目。
        - 项目标题 + 启动全部/停止全部按钮。
        - 服务列表：
            - 服务名称 + 状态指示灯 (绿/灰/红)。
            - 操作按钮：启动/停止/重启。
            - 端口信息：显示监听端口。
- **交互反馈**：
    - 操作成功/失败弹出 Toast 提示。
    - 按钮点击后禁用 1-2 秒防抖。

## 五、 安全设计
- **本地绑定**：仅监听 `127.0.0.1`，防止局域网内其他机器访问。
- **进程隔离**：不同服务运行在各自的子进程中，互不干扰。
- **系统保护**：停止服务时严格校验 PID，禁止操作 PID 0 (System Idle) 和 PID 4 (System)。
