# 项目端口管理器 - 开发文档 (v1.0)

## 一、 环境搭建 (Setup)

### 1.1 系统要求
- **OS**: Windows 10/11 (推荐), macOS/Linux (需自行修改部分脚本)
- **Python**: 3.11+
- **Node.js**: (可选，仅用于运行前端构建工具，本项目前端为纯 HTML/JS 无需构建)

### 1.2 安装步骤
1.  **克隆代码**：
    ```bash
    git clone <repository_url> project-port-manager
    cd project-port-manager
    ```
2.  **创建虚拟环境** (推荐)：
    ```bash
    python -m venv venv
    .\venv\Scripts\activate
    ```
3.  **安装依赖**：
    ```bash
    pip install fastapi uvicorn requests psutil
    ```
    *(注：本项目核心依赖仅 `fastapi`, `uvicorn`, `pydantic`，无需 `requests` 和 `psutil`，使用标准库即可)*

### 1.3 启动开发服务器
- **方式一：直接运行**
    ```bash
    python app.py
    # 或
    uvicorn app:app --reload --host 127.0.0.1 --port 5555
    ```
- **方式二：使用启动脚本**
    - 双击 `start_port_manager.bat` 或 `start_port_manager.ps1`。
    - 该脚本会自动检查端口占用并尝试清理。

## 二、 项目结构 (Structure)

```
project-port-manager/
├── app.py                  # 后端入口 (FastAPI)
├── config.json             # 项目配置文件 (核心数据)
├── static/                 # 前端静态资源
│   └── index.html          # 单页应用入口
├── docs/                   # 项目文档
│   ├── 需求文档.md
│   ├── 评审文档.md
│   ├── 设计文档.md
│   └── 开发文档.md
├── start_port_manager.bat  # Windows 启动脚本 (CMD)
└── start_port_manager.ps1  # Windows 启动脚本 (PowerShell)
```

## 三、 核心代码逻辑说明

### 3.1 配置文件 (`config.json`)
- **路径**：`d:\Docs\03AI\01Trae\project-port-manager\config.json`
- **格式**：JSON 数组，每个元素为一个项目配置。
- **示例**：
    ```json
    {
      "projects": [
        {
          "id": "my-project",
          "name": "My Project",
          "root_path": "C:\\Projects\\MyProject",
          "services": [...]
        }
      ]
    }
    ```

### 3.2 停止服务逻辑 (`app.py: stop_service`)
该函数负责安全停止服务，逻辑如下：
1.  **检查 `processes` 字典**：看是否有名为 `service_id` 的进程对象。
2.  **若存在**：
    - Windows: `taskkill /F /T /PID {pid}` (强制结束进程树)。
    - Unix: `proc.terminate()`。
3.  **若不存在 (或已失效)**：
    - 读取 `config.json` 中该服务的端口列表。
    - 对每个端口，执行 `netstat -ano | findstr :{port}` 查找 PID。
    - **安全校验**：PID 不能为 `0` 或 `4`。
    - 执行 `taskkill /F /PID {pid}`。

### 3.3 启动脚本逻辑 (`start_port_manager.ps1`)
- **功能**：
    - 设置 UTF-8 编码 (`chcp 65001`)。
    - 定义 `Kill-PortProcess` 函数：检查端口 5555 是否被占用，若有则杀掉。
    - 启动 `uvicorn` 服务。
    - 打开默认浏览器访问 `http://127.0.0.1:5555`。

## 四、 开发指南 (Guide)

### 4.1 添加新功能
- **修改后端**：在 `app.py` 中添加新的路由函数，使用 `@app.get/post` 装饰器。
- **修改前端**：直接编辑 `static/index.html`，使用 `fetch` 调用新接口，并更新 DOM。
- **修改配置结构**：
    1.  更新 `config.json` 示例数据。
    2.  修改 `app.py` 中的 Pydantic 模型 (`ServiceConfig`, `ProjectConfig`)。

### 4.2 调试技巧
- **后端调试**：使用 VS Code 的 Python Debugger，配置 `launch.json` 指向 `app.py`。
- **前端调试**：使用浏览器开发者工具 (F12)，查看 Network 请求和 Console 日志。
- **进程调试**：使用 `Process Explorer` 或 `Task Manager` 查看进程树关系。

## 五、 版本发布 (Release)
1.  **更新文档**：确保 `docs/` 下的所有文档与当前代码一致。
2.  **清理代码**：移除所有 `print` 调试语句，统一使用 `logging`。
3.  **打包** (可选)：使用 `PyInstaller` 将项目打包为单个 exe 文件，方便分发。
    ```bash
    pyinstaller --onefile --name project-port-manager app.py
    ```

## 六、 常见问题 (FAQ)
- **Q: 为什么启动脚本一闪而过？**
    - A: 可能是 PowerShell 执行策略限制，尝试以管理员身份运行 `Set-ExecutionPolicy RemoteSigned`。或者脚本中存在语法错误（如中文括号）。
- **Q: 为什么停止服务后端口仍被占用？**
    - A: 可能是子进程未被正确关闭。请确认使用了 `taskkill /T` 参数。
