<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>Project Port Manager</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#0f172a;color:#e5e7eb}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:#020617;border-bottom:1px solid #1f2937}
    .brand{font-size:16px;font-weight:600;color:#e5e7eb}
    .nav{display:flex;gap:12px}
    .nav button{background:transparent;border:none;color:#9ca3af;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:13px}
    .nav button.active{background:#1d4ed8;color:#e5e7eb}
    .nav button:hover{background:#111827}
    .page{padding:16px 20px}
    .cards{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:16px}
    .card{background:#020617;border:1px solid #1f2937;border-radius:8px;padding:10px 12px;min-width:150px}
    .card-title{font-size:12px;color:#9ca3af;margin-bottom:4px}
    .card-value{font-size:18px;font-weight:600}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{text-align:left;padding:8px}
    th{background:#020617;color:#9ca3af;border-bottom:1px solid #1f2937}
    tr:nth-child(even){background:#020617}
    tr:nth-child(odd){background:#020617}
    tr:hover{background:#111827}
    .tag{display:inline-block;padding:2px 6px;border-radius:999px;font-size:11px;margin-right:4px}
    .tag-backend{background:#1e293b;color:#bfdbfe}
    .tag-frontend{background:#1e293b;color:#bbf7d0}
    .status-dot{width:8px;height:8px;border-radius:999px;display:inline-block;margin-right:4px}
    .status-running{background:#22c55e}
    .status-stopped{background:#6b7280}
    .btn{border:none;border-radius:4px;padding:4px 8px;font-size:12px;cursor:pointer}
    .btn-primary{background:#2563eb;color:white}
    .btn-danger{background:#b91c1c;color:white}
    .btn-ghost{background:transparent;color:#e5e7eb;border:1px solid #374151}
    .btn+ .btn{margin-left:6px}
    .pill{display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;font-size:11px;background:#020617;border:1px solid #1f2937}
    .pill-green{border-color:#16a34a;color:#bbf7d0}
    .pill-gray{border-color:#4b5563;color:#e5e7eb}
    .section-title{font-size:14px;font-weight:600;margin-bottom:8px}
    .subtle{color:#9ca3af;font-size:12px}
    .mt-16{margin-top:16px}
    .mt-8{margin-top:8px}
    .link{color:#60a5fa;cursor:pointer}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">Project Port Manager</div>
    <div class="nav">
      <button id="tab-dashboard" class="active" onclick="switchTab('dashboard')">Dashboard</button>
      <button id="tab-projects" onclick="switchTab('projects')">Projects</button>
      <button id="tab-ports" onclick="switchTab('ports')">Ports</button>
    </div>
  </div>
  <div id="page-dashboard" class="page">
    <div class="section-title">概览</div>
    <div class="cards">
      <div class="card">
        <div class="card-title">项目数</div>
        <div class="card-value" id="stat-projects">0</div>
      </div>
      <div class="card">
        <div class="card-title">服务数</div>
        <div class="card-value" id="stat-services">0 / 0</div>
      </div>
      <div class="card">
        <div class="card-title">后台服务运行中</div>
        <div class="card-value" id="stat-backend">0</div>
      </div>
      <div class="card">
        <div class="card-title">前台服务运行中</div>
        <div class="card-value" id="stat-frontend">0</div>
      </div>
    </div>
    <div class="toolbar">
      <div class="section-title">项目运行状态</div>
      <button class="btn btn-ghost" onclick="refreshAll()">刷新</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>项目名称</th>
          <th>项目 ID</th>
          <th>后台</th>
          <th>前台</th>
          <th>端口</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="dashboard-projects-body">
      </tbody>
    </table>
    <div class="mt-8 subtle" id="dashboard-empty"></div>
  </div>

  <div id="page-projects" class="page" style="display:none">
    <div class="toolbar">
      <div class="section-title">项目列表</div>
      <button class="btn btn-ghost" onclick="refreshAll()">刷新</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>项目名称</th>
          <th>项目 ID</th>
          <th>根目录</th>
          <th>服务</th>
          <th>运行中</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="projects-body">
      </tbody>
    </table>
    <div class="mt-16">
      <div class="section-title">项目详情</div>
      <div class="subtle" id="project-detail-title">请选择一个项目查看详情</div>
      <div id="project-detail" class="mt-8"></div>
    </div>
  </div>

  <div id="page-ports" class="page" style="display:none">
    <div class="toolbar">
      <div class="section-title">端口视图</div>
      <button class="btn btn-ghost" onclick="refreshAll()">刷新</button>
    </div>
    <div class="subtle">当前版本会根据端口占用情况推断服务是否运行，即使由外部启动。</div>
    <table class="mt-8">
      <thead>
        <tr>
          <th>端口</th>
          <th>状态</th>
          <th>项目</th>
          <th>服务</th>
        </tr>
      </thead>
      <tbody id="ports-body">
      </tbody>
    </table>
  </div>

  <script>
    let projects = []
    let serviceStatus = []
    let selectedProjectId = null

    function openFrontend(url) {
      if (!url) return
      window.open(url, '_blank')
    }

    function switchTab(tab) {
      document.getElementById('page-dashboard').style.display = tab === 'dashboard' ? 'block' : 'none'
      document.getElementById('page-projects').style.display = tab === 'projects' ? 'block' : 'none'
      document.getElementById('page-ports').style.display = tab === 'ports' ? 'block' : 'none'
      document.getElementById('tab-dashboard').classList.toggle('active', tab === 'dashboard')
      document.getElementById('tab-projects').classList.toggle('active', tab === 'projects')
      document.getElementById('tab-ports').classList.toggle('active', tab === 'ports')
    }

    async function refreshAll() {
      try {
        const [projectsRes, statusRes] = await Promise.all([
          fetch('/projects'),
          fetch('/services/status')
        ])
        projects = await projectsRes.json()
        serviceStatus = await statusRes.json()
        renderDashboard()
        renderProjects()
        renderPorts()
      } catch (e) {
        console.error(e)
      }
    }

    function getServiceStatusMap() {
      const map = {}
      for (const s of serviceStatus) {
        map[s.service_id] = s
      }
      return map
    }

    function renderDashboard() {
      const statusMap = getServiceStatusMap()
      const totalProjects = projects.length
      let totalServices = 0
      let runningServices = 0
      let backendRunning = 0
      let frontendRunning = 0
      const tbody = document.getElementById('dashboard-projects-body')
      tbody.innerHTML = ''

      for (const p of projects) {
        let projectTotal = 0
        let projectRunning = 0
        let projectBackendRunning = 0
        let projectFrontendRunning = 0
        const portsSet = new Set()
        for (const svc of p.services) {
          projectTotal += 1
          totalServices += 1
          const st = statusMap[svc.id]
          const running = st && st.running
          if (running) {
            projectRunning += 1
            runningServices += 1
            if (svc.type === 'backend') {
              projectBackendRunning += 1
              backendRunning += 1
            } else if (svc.type === 'frontend') {
              projectFrontendRunning += 1
              frontendRunning += 1
            }
          }
          for (const port of svc.ports || []) {
            portsSet.add(port)
          }
        }
        const tr = document.createElement('tr')
        const backendCell = projectTotal === 0 ? '0/0' : projectBackendRunning + '/' + p.services.filter(s => s.type === 'backend').length
        const frontendCell = projectTotal === 0 ? '0/0' : projectFrontendRunning + '/' + p.services.filter(s => s.type === 'frontend').length
        tr.innerHTML =
          '<td>' + p.name + '</td>' +
          '<td>' + p.id + '</td>' +
          '<td>' + backendCell + '</td>' +
          '<td>' + frontendCell + '</td>' +
          '<td>' + Array.from(portsSet).join(', ') + '</td>' +
          '<td>' +
          '<button class="btn btn-primary" onclick="startProject(\'' + p.id + '\')">启动全部</button>' +
          '<button class="btn btn-danger" onclick="stopProject(\'' + p.id + '\')">停止全部</button>' +
          '</td>'
        tbody.appendChild(tr)
      }

      document.getElementById('stat-projects').textContent = String(totalProjects)
      document.getElementById('stat-services').textContent = runningServices + ' / ' + totalServices
      document.getElementById('stat-backend').textContent = String(backendRunning)
      document.getElementById('stat-frontend').textContent = String(frontendRunning)
      const empty = document.getElementById('dashboard-empty')
      empty.textContent = totalProjects === 0 ? '当前尚未在 config.json 中配置任何项目。' : ''
    }

    function renderProjects() {
      const statusMap = getServiceStatusMap()
      const tbody = document.getElementById('projects-body')
      tbody.innerHTML = ''
      for (const p of projects) {
        let total = p.services.length
        let running = 0
        for (const svc of p.services) {
          const st = statusMap[svc.id]
          if (st && st.running) {
            running += 1
          }
        }
        const tr = document.createElement('tr')
        tr.innerHTML =
          '<td>' + p.name + '</td>' +
          '<td>' + p.id + '</td>' +
          '<td><span class="subtle">' + p.root_path + '</span></td>' +
          '<td>' + total + '</td>' +
          '<td>' + running + '</td>' +
          '<td>' +
          '<button class="btn btn-primary" onclick="startProject(\'' + p.id + '\')">启动全部</button>' +
          '<button class="btn btn-danger" onclick="stopProject(\'' + p.id + '\')">停止全部</button>' +
          '<button class="btn btn-ghost" onclick="showProjectDetail(\'' + p.id + '\')">详情</button>' +
          '</td>'
        tbody.appendChild(tr)
      }
      if (selectedProjectId && projects.find(p => p.id === selectedProjectId)) {
        showProjectDetail(selectedProjectId)
      }
    }

    function showProjectDetail(projectId) {
      selectedProjectId = projectId
      const p = projects.find(x => x.id === projectId)
      if (!p) {
        document.getElementById('project-detail-title').textContent = '未找到项目。'
        document.getElementById('project-detail').innerHTML = ''
        return
      }
      document.getElementById('project-detail-title').textContent = p.name + ' (' + p.id + ')'
      const statusMap = getServiceStatusMap()
      let html = ''
      html += '<div class="subtle">根目录: ' + p.root_path + '</div>'
      if (p.frontend_url) {
        const safeUrl = p.frontend_url
        html += '<div class="mt-8">' +
          '<button class="btn btn-primary" onclick="openFrontend(\'' + safeUrl + '\')">打开前端首页</button>' +
          ' <span class="subtle">' + safeUrl + '</span>' +
          '</div>'
      }
      html += '<table class="mt-8"><thead><tr>' +
        '<th>服务名称</th><th>类型</th><th>工作目录</th><th>命令</th><th>端口</th><th>状态</th><th>操作</th>' +
        '</tr></thead><tbody>'
      for (const svc of p.services) {
        const st = statusMap[svc.id]
        const running = st && st.running
        const dotClass = running ? 'status-dot status-running' : 'status-dot status-stopped'
        let statusText
        if (running) {
          if (st && st.manager_running) {
            if (st.pid) {
              statusText = '运行中 (PID ' + st.pid + ')'
            } else {
              statusText = '运行中'
            }
          } else if (st && st.port_occupied) {
            statusText = '端口占用（外部进程）'
          } else {
            statusText = '运行中'
          }
        } else {
          statusText = '未运行'
        }
        const tagClass = svc.type === 'backend' ? 'tag tag-backend' : svc.type === 'frontend' ? 'tag tag-frontend' : 'tag'
        const ports = (svc.ports || []).join(', ')
        html += '<tr>' +
          '<td>' + svc.name + '</td>' +
          '<td><span class="' + tagClass + '">' + svc.type + '</span></td>' +
          '<td><span class="subtle">' + svc.cwd + '</span></td>' +
          '<td><span class="subtle">' + svc.command + '</span></td>' +
          '<td>' + ports + '</td>' +
          '<td><span class="' + dotClass + '"></span>' + statusText + '</td>' +
          '<td>' +
          '<button class="btn btn-primary" onclick="startService(\'' + svc.id + '\')">启动</button>' +
          '<button class="btn btn-danger" onclick="stopService(\'' + svc.id + '\')">停止</button>' +
          '<button class="btn btn-ghost" onclick="restartService(\'' + svc.id + '\')">重启</button>' +
          '</td>' +
          '</tr>'
      }
      html += '</tbody></table>'
      document.getElementById('project-detail').innerHTML = html
    }

    function renderPorts() {
      const statusMap = getServiceStatusMap()
      const rows = []
      for (const p of projects) {
        for (const svc of p.services) {
          const st = statusMap[svc.id]
          const running = st && st.running
          for (const port of svc.ports || []) {
            rows.push({
              port,
              project: p,
              service: svc,
              running
            })
          }
        }
      }
      rows.sort((a,b) => a.port - b.port)
      const tbody = document.getElementById('ports-body')
      tbody.innerHTML = ''
      for (const r of rows) {
        const tr = document.createElement('tr')
        const dotClass = r.running ? 'status-dot status-running' : 'status-dot status-stopped'
        const statusText = r.running ? '运行中' : '未运行'
        tr.innerHTML =
          '<td>' + r.port + '</td>' +
          '<td><span class="' + dotClass + '"></span>' + statusText + '</td>' +
          '<td>' + r.project.name + '</td>' +
          '<td>' + r.service.name + '</td>'
        tbody.appendChild(tr)
      }
    }

    async function startProject(projectId) {
      try {
        await fetch('/projects/' + encodeURIComponent(projectId) + '/start', {method:'POST'})
        await refreshAll()
      } catch (e) {
        console.error(e)
      }
    }

    async function stopProject(projectId) {
      try {
        await fetch('/projects/' + encodeURIComponent(projectId) + '/stop', {method:'POST'})
        await refreshAll()
      } catch (e) {
        console.error(e)
      }
    }

    async function startService(serviceId) {
      try {
        await fetch('/services/' + encodeURIComponent(serviceId) + '/start', {method:'POST'})
        await refreshAll()
      } catch (e) {
        console.error(e)
      }
    }

    async function stopService(serviceId) {
      try {
        await fetch('/services/' + encodeURIComponent(serviceId) + '/stop', {method:'POST'})
        await refreshAll()
      } catch (e) {
        console.error(e)
      }
    }

    async function restartService(serviceId) {
      try {
        await fetch('/services/' + encodeURIComponent(serviceId) + '/stop', {method:'POST'})
        await fetch('/services/' + encodeURIComponent(serviceId) + '/start', {method:'POST'})
        await refreshAll()
      } catch (e) {
        console.error(e)
      }
    }

    refreshAll()
    setInterval(refreshAll, 8000)
  </script>
</body>
</html>
